import { GraphQL } from "./graphql.js";
export class Dropdown {
    constructor(dropdownNodeOrId) {
        if (dropdownNodeOrId instanceof HTMLDivElement)
            this.dropdownNode = dropdownNodeOrId;
        else
            this.dropdownNode = document.getElementById(dropdownNodeOrId);
        if (!this.dropdownNode)
            throw "The dropdown node is null. Parameter given was: " + dropdownNodeOrId;
        // For now, we only support Fomantic UI style, since I doubt it'll be replaced anytime soon.
        this.inputNode = this.dropdownNode.querySelector("div.dropdown input[type=hidden]");
        if (!this.inputNode)
            throw "Could not find the input element. Is your markup in Fomantic UI style?";
        this.menuNode = this.dropdownNode.querySelector("div.dropdown div.menu");
        if (!this.menuNode)
            throw "Could not find the menu element. Is your markup in Fomantic UI style?";
        this.containerNode = this.inputNode.parentNode;
        if (!this.containerNode)
            throw "Could not find the container element. Is your markup in Fomantic UI style?";
        this.defaultValue = this.inputNode.dataset.defaultValue;
        this.isMultipleSelect = this.containerNode.classList.contains("multiple");
        const refreshButton = this.dropdownNode.querySelector("label .button[data-type=refresh]");
        refreshButton.addEventListener("click", () => this.refresh());
        // Just to make sure Fomantic UI knows about it, saving the user the hassle.
        $(this.menuNode.parentNode).dropdown({ forceSelection: false });
        this._refreshFunc = function () { alert("No refresh function has been assigned."); };
    }
    // UTILITY FUNCTIONS
    isDefaultValue(value) {
        return (this.isMultipleSelect)
            ? this.defaultValue.split(",").indexOf(value) > -1
            : value === this.defaultValue;
    }
    // FUNCTIONS TO MANIPULATE ITEMS
    addItem(
    // Gotta love TS' syntax.
    { name, value = null, isSelected = false }) {
        const item = this.menuNode.appendChild(document.createElement("div"));
        item.classList.add("item");
        item.innerText = name;
        if (value)
            item.dataset.value = value;
        if (isSelected) {
            // Fomantic UI's own functions are too buggy to use, so we do things ourselves
            item.classList.add("active", (this.isMultipleSelect) ? "filtered" : "selected");
            if (this.isMultipleSelect) {
                if (this.inputNode.value.length > 0)
                    this.inputNode.value += ",";
                this.inputNode.value += (!value) ? name : value;
                // If only Fomantic UI's user JS ever worked right....
                const dropdownIcon = this.containerNode.querySelector("i.dropdown.icon");
                const boxWithItem = document.createElement("a");
                dropdownIcon.after(boxWithItem);
                boxWithItem.classList.add("ui", "label");
                boxWithItem.dataset.value = value || name;
                boxWithItem.innerText = name;
                const i = boxWithItem.appendChild(document.createElement("i"));
                i.classList.add("delete", "icon");
            }
            else {
                this.inputNode.value = (!value) ? name : value;
                const textbox = this.dropdownNode.querySelector("div.dropdown div.text");
                textbox.innerText = name;
            }
            this.inputNode.dispatchEvent(new Event("change"));
        }
        return item;
    }
    clear() {
        while (this.menuNode.firstChild)
            this.menuNode.removeChild(this.menuNode.firstChild);
        const textbox = this.dropdownNode.querySelector("div.dropdown div.text");
        textbox.innerText = "";
    }
    refresh() {
        this._refreshFunc();
    }
    // GENERIC DATA SOURCES
    fromRefreshFunc(func) {
        this._refreshFunc = func;
    }
    fromGraphQL({ query, parameters = null, dataGetter }) {
        this.fromRefreshFunc(() => {
            GraphQL
                .query(query, parameters)
                .then((data) => {
                this.clear();
                const nameValuePairs = dataGetter(data);
                for (const pair of nameValuePairs)
                    this.addItem({ name: pair.name, value: pair.value, isSelected: this.isDefaultValue(pair.value) });
            })
                .catch((reason) => {
                alert("TEMP error handling: " + JSON.stringify(reason));
            });
        });
        this.refresh();
    }
    // COMMON DROPDOWN DATA SOURCES
    //
    // If the data source is used in more than one page, its probably best to put it here.
    fromNameIdGraphQL(entityName) {
        this.fromGraphQL({
            query: `query GetOwners {
                ${entityName} {
                    id
                    name
                }
            }`,
            dataGetter: (json) => json[entityName].map(function (v) {
                return { name: v.name, value: String(v.id) };
            })
        });
    }
    fromContactGraphQL() {
        this.fromNameIdGraphQL("contacts");
    }
    fromSpeciesGraphQL() {
        this.fromNameIdGraphQL("species");
    }
    fromHoldingGraphQL() {
        this.fromNameIdGraphQL("holdings");
    }
    fromAnimalGroupGraphQL() {
        this.fromNameIdGraphQL("animalGroups");
    }
    fromBreedGraphQL() {
        this.fromNameIdGraphQL("breeds");
    }
    fromLifeEventGraphQL() {
        this.fromNameIdGraphQL("lifeEvents");
    }
}
export default Dropdown;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9TY3JpcHRzL2Ryb3Bkb3duLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFFdEMsTUFBTSxPQUFPLFFBQVE7SUFTakIsWUFBWSxnQkFBeUM7UUFDakQsSUFBSSxnQkFBZ0IsWUFBWSxjQUFjO1lBQzFDLElBQUksQ0FBQyxZQUFZLEdBQUcsZ0JBQWdCLENBQUM7O1lBRXJDLElBQUksQ0FBQyxZQUFZLEdBQW1CLFFBQVEsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUVsRixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVk7WUFDbEIsTUFBTSxrREFBa0QsR0FBRyxnQkFBZ0IsQ0FBQztRQUVoRiw0RkFBNEY7UUFDNUYsSUFBSSxDQUFDLFNBQVMsR0FBcUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsaUNBQWlDLENBQUMsQ0FBQztRQUN0RyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7WUFDZixNQUFNLHdFQUF3RSxDQUFDO1FBRW5GLElBQUksQ0FBQyxRQUFRLEdBQW1CLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDekYsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRO1lBQ2QsTUFBTSx1RUFBdUUsQ0FBQztRQUVsRixJQUFJLENBQUMsYUFBYSxHQUFtQixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztRQUMvRCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWE7WUFDbkIsTUFBTSw0RUFBNEUsQ0FBQztRQUV2RixJQUFJLENBQUMsWUFBWSxHQUFXLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUNoRSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFD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LENBQUM7SUFDdEMsQ0FBQztJQUVNLGtCQUFrQjtRQUNyQixJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVNLHNCQUFzQjtRQUN6QixJQUFJLENBQUMsaUJBQWlCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVNLGdCQUFnQjtRQUNuQixJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVNLG9CQUFvQjtRQUN2QixJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDekMsQ0FBQztDQUNKO0FBRUQsZUFBZSxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHcmFwaFFMIH0gZnJvbSBcIi4vZ3JhcGhxbC5qc1wiXHJcblxyXG5leHBvcnQgY2xhc3MgRHJvcGRvd24ge1xyXG4gICAgcHVibGljIHJlYWRvbmx5IGRyb3Bkb3duTm9kZTogSFRNTERpdkVsZW1lbnQ7XHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgaW5wdXROb2RlOiBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgcHVibGljIHJlYWRvbmx5IG1lbnVOb2RlOiBIVE1MRGl2RWxlbWVudDtcclxuICAgIHB1YmxpYyByZWFkb25seSBjb250YWluZXJOb2RlOiBIVE1MRGl2RWxlbWVudDtcclxuICAgIHB1YmxpYyByZWFkb25seSBkZWZhdWx0VmFsdWU6IHN0cmluZztcclxuICAgIHB1YmxpYyByZWFkb25seSBpc011bHRpcGxlU2VsZWN0OiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBfcmVmcmVzaEZ1bmM6IEZ1bmN0aW9uO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGRyb3Bkb3duTm9kZU9ySWQ6IEhUTUxEaXZFbGVtZW50IHwgc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKGRyb3Bkb3duTm9kZU9ySWQgaW5zdGFuY2VvZiBIVE1MRGl2RWxlbWVudClcclxuICAgICAgICAgICAgdGhpcy5kcm9wZG93bk5vZGUgPSBkcm9wZG93bk5vZGVPcklkO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5kcm9wZG93bk5vZGUgPSA8SFRNTERpdkVsZW1lbnQ+ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZHJvcGRvd25Ob2RlT3JJZCk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5kcm9wZG93bk5vZGUpXHJcbiAgICAgICAgICAgIHRocm93IFwiVGhlIGRyb3Bkb3duIG5vZGUgaXMgbnVsbC4gUGFyYW1ldGVyIGdpdmVuIHdhczogXCIgKyBkcm9wZG93bk5vZGVPcklkO1xyXG5cclxuICAgICAgICAvLyBGb3Igbm93LCB3ZSBvbmx5IHN1cHBvcnQgRm9tYW50aWMgVUkgc3R5bGUsIHNpbmNlIEkgZG91YnQgaXQnbGwgYmUgcmVwbGFjZWQgYW55dGltZSBzb29uLlxyXG4gICAgICAgIHRoaXMuaW5wdXROb2RlID0gPEhUTUxJbnB1dEVsZW1lbnQ+dGhpcy5kcm9wZG93bk5vZGUucXVlcnlTZWxlY3RvcihcImRpdi5kcm9wZG93biBpbnB1dFt0eXBlPWhpZGRlbl1cIik7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlucHV0Tm9kZSlcclxuICAgICAgICAgICAgdGhyb3cgXCJDb3VsZCBub3QgZmluZCB0aGUgaW5wdXQgZWxlbWVudC4gSXMgeW91ciBtYXJrdXAgaW4gRm9tYW50aWMgVUkgc3R5bGU/XCI7XHJcblxyXG4gICAgICAgIHRoaXMubWVudU5vZGUgPSA8SFRNTERpdkVsZW1lbnQ+dGhpcy5kcm9wZG93bk5vZGUucXVlcnlTZWxlY3RvcihcImRpdi5kcm9wZG93biBkaXYubWVudVwiKTtcclxuICAgICAgICBpZiAoIXRoaXMubWVudU5vZGUpXHJcbiAgICAgICAgICAgIHRocm93IFwiQ291bGQgbm90IGZpbmQgdGhlIG1lbnUgZWxlbWVudC4gSXMgeW91ciBtYXJrdXAgaW4gRm9tYW50aWMgVUkgc3R5bGU/XCI7XHJcblxyXG4gICAgICAgIHRoaXMuY29udGFpbmVyTm9kZSA9IDxIVE1MRGl2RWxlbWVudD50aGlzLmlucHV0Tm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgIGlmICghdGhpcy5jb250YWluZXJOb2RlKVxyXG4gICAgICAgICAgICB0aHJvdyBcIkNvdWxkIG5vdCBmaW5kIHRoZSBjb250YWluZXIgZWxlbWVudC4gSXMgeW91ciBtYXJrdXAgaW4gRm9tYW50aWMgVUkgc3R5bGU/XCI7XHJcblxyXG4gICAgICAgIHRoaXMuZGVmYXVsdFZhbHVlID0gPHN0cmluZz50aGlzLmlucHV0Tm9kZS5kYXRhc2V0LmRlZmF1bHRWYWx1ZTtcclxuICAgICAgICB0aGlzLmlzTXVsdGlwbGVTZWxlY3QgPSB0aGlzLmNvbnRhaW5lck5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKFwibXVsdGlwbGVcIik7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlZnJlc2hCdXR0b24gPSA8SFRNTEVsZW1lbnQ+dGhpcy5kcm9wZG93bk5vZGUucXVlcnlTZWxlY3RvcihcImxhYmVsIC5idXR0b25bZGF0YS10eXBlPXJlZnJlc2hdXCIpO1xyXG4gICAgICAgIHJlZnJlc2hCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHRoaXMucmVmcmVzaCgpKTtcclxuXHJcbiAgICAgICAgLy8gSnVzdCB0byBtYWtlIHN1cmUgRm9tYW50aWMgVUkga25vd3MgYWJvdXQgaXQsIHNhdmluZyB0aGUgdXNlciB0aGUgaGFzc2xlLlxyXG4gICAgICAgICQoPGFueT50aGlzLm1lbnVOb2RlLnBhcmVudE5vZGUpLmRyb3Bkb3duKHsgZm9yY2VTZWxlY3Rpb246IGZhbHNlIH0pO1xyXG5cclxuICAgICAgICB0aGlzLl9yZWZyZXNoRnVuYyA9IGZ1bmN0aW9uICgpIHsgYWxlcnQoXCJObyByZWZyZXNoIGZ1bmN0aW9uIGhhcyBiZWVuIGFzc2lnbmVkLlwiKTsgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVVElMSVRZIEZVTkNUSU9OU1xyXG5cclxuICAgIHB1YmxpYyBpc0RlZmF1bHRWYWx1ZSh2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICh0aGlzLmlzTXVsdGlwbGVTZWxlY3QpXHJcbiAgICAgICAgICAgID8gdGhpcy5kZWZhdWx0VmFsdWUuc3BsaXQoXCIsXCIpLmluZGV4T2YodmFsdWUpID4gLTFcclxuICAgICAgICAgICAgOiB2YWx1ZSA9PT0gdGhpcy5kZWZhdWx0VmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRlVOQ1RJT05TIFRPIE1BTklQVUxBVEUgSVRFTVNcclxuXHJcbiAgICBwdWJsaWMgYWRkSXRlbShcclxuICAgICAgICAvLyBHb3R0YSBsb3ZlIFRTJyBzeW50YXguXHJcbiAgICAgICAgeyBuYW1lLCAgICAgICAgIHZhbHVlID0gbnVsbCwgICAgICAgICAgaXNTZWxlY3RlZCA9IGZhbHNlIH06XHJcbiAgICAgICAgeyBuYW1lOiBzdHJpbmcsIHZhbHVlPzogc3RyaW5nIHwgbnVsbCwgaXNTZWxlY3RlZDogYm9vbGVhbiB9XHJcbiAgICApOiBIVE1MRGl2RWxlbWVudCB7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMubWVudU5vZGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XHJcbiAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKFwiaXRlbVwiKTtcclxuICAgICAgICBpdGVtLmlubmVyVGV4dCA9IG5hbWU7XHJcblxyXG4gICAgICAgIGlmICh2YWx1ZSlcclxuICAgICAgICAgICAgaXRlbS5kYXRhc2V0LnZhbHVlID0gdmFsdWU7XHJcblxyXG4gICAgICAgIGlmIChpc1NlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgIC8vIEZvbWFudGljIFVJJ3Mgb3duIGZ1bmN0aW9ucyBhcmUgdG9vIGJ1Z2d5IHRvIHVzZSwgc28gd2UgZG8gdGhpbmdzIG91cnNlbHZlc1xyXG4gICAgICAgICAgICBpdGVtLmNsYXNzTGlzdC5hZGQoXCJhY3RpdmVcIiwgKHRoaXMuaXNNdWx0aXBsZVNlbGVjdCkgPyBcImZpbHRlcmVkXCIgOiBcInNlbGVjdGVkXCIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNNdWx0aXBsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXROb2RlLnZhbHVlLmxlbmd0aCA+IDApXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dE5vZGUudmFsdWUgKz0gXCIsXCI7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnB1dE5vZGUudmFsdWUgKz0gKCF2YWx1ZSkgPyBuYW1lIDogdmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gSWYgb25seSBGb21hbnRpYyBVSSdzIHVzZXIgSlMgZXZlciB3b3JrZWQgcmlnaHQuLi4uXHJcbiAgICAgICAgICAgICAgICBjb25zdCBkcm9wZG93bkljb24gPSA8SFRNTEVsZW1lbnQ+dGhpcy5jb250YWluZXJOb2RlLnF1ZXJ5U2VsZWN0b3IoXCJpLmRyb3Bkb3duLmljb25cIik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBib3hXaXRoSXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhXCIpO1xyXG5cclxuICAgICAgICAgICAgICAgIGRyb3Bkb3duSWNvbi5hZnRlcihib3hXaXRoSXRlbSk7XHJcbiAgICAgICAgICAgICAgICBib3hXaXRoSXRlbS5jbGFzc0xpc3QuYWRkKFwidWlcIiwgXCJsYWJlbFwiKTtcclxuICAgICAgICAgICAgICAgIGJveFdpdGhJdGVtLmRhdGFzZXQudmFsdWUgPSB2YWx1ZSB8fCBuYW1lO1xyXG4gICAgICAgICAgICAgICAgYm94V2l0aEl0ZW0uaW5uZXJUZXh0ID0gbmFtZTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpID0gYm94V2l0aEl0ZW0uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImlcIikpO1xyXG4gICAgICAgICAgICAgICAgaS5jbGFzc0xpc3QuYWRkKFwiZGVsZXRlXCIsIFwiaWNvblwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5wdXROb2RlLnZhbHVlID0gKCF2YWx1ZSkgPyBuYW1lIDogdmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dGJveCA9IDxIVE1MRGl2RWxlbWVudD50aGlzLmRyb3Bkb3duTm9kZS5xdWVyeVNlbGVjdG9yKFwiZGl2LmRyb3Bkb3duIGRpdi50ZXh0XCIpO1xyXG4gICAgICAgICAgICAgICAgdGV4dGJveC5pbm5lclRleHQgPSBuYW1lO1xyXG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgdGhpcy5pbnB1dE5vZGUuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoXCJjaGFuZ2VcIikpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGl0ZW07XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgICAgIHdoaWxlICh0aGlzLm1lbnVOb2RlLmZpcnN0Q2hpbGQpXHJcbiAgICAgICAgICAgIHRoaXMubWVudU5vZGUucmVtb3ZlQ2hpbGQodGhpcy5tZW51Tm9kZS5maXJzdENoaWxkKTtcclxuXHJcbiAgICAgICAgY29uc3QgdGV4dGJveCA9IDxIVE1MRGl2RWxlbWVudD50aGlzLmRyb3Bkb3duTm9kZS5xdWVyeVNlbGVjdG9yKFwiZGl2LmRyb3Bkb3duIGRpdi50ZXh0XCIpO1xyXG4gICAgICAgIHRleHRib3guaW5uZXJUZXh0ID0gXCJcIjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVmcmVzaCgpIHtcclxuICAgICAgICB0aGlzLl9yZWZyZXNoRnVuYygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEdFTkVSSUMgREFUQSBTT1VSQ0VTXHJcblxyXG4gICAgcHVibGljIGZyb21SZWZyZXNoRnVuYyhmdW5jOiBGdW5jdGlvbikge1xyXG4gICAgICAgIHRoaXMuX3JlZnJlc2hGdW5jID0gZnVuYztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZnJvbUdyYXBoUUwoXHJcbiAgICAgICAgeyBxdWVyeSwgICAgICAgICBwYXJhbWV0ZXJzID0gbnVsbCwgICAgICAgICAgZGF0YUdldHRlciB9OlxyXG4gICAgICAgIHsgcXVlcnk6IHN0cmluZywgcGFyYW1ldGVycz86IG9iamVjdCB8IG51bGwsIGRhdGFHZXR0ZXI6IChkYXRhOiBhbnkpID0+IHsgbmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIH1bXSB9XHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLmZyb21SZWZyZXNoRnVuYygoKSA9PiB7XHJcbiAgICAgICAgICAgIEdyYXBoUUxcclxuICAgICAgICAgICAgICAgIC5xdWVyeShxdWVyeSwgcGFyYW1ldGVycylcclxuICAgICAgICAgICAgICAgIC50aGVuKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lVmFsdWVQYWlycyA9IGRhdGFHZXR0ZXIoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBwYWlyIG9mIG5hbWVWYWx1ZVBhaXJzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEl0ZW0oeyBuYW1lOiBwYWlyLm5hbWUsIHZhbHVlOiBwYWlyLnZhbHVlLCBpc1NlbGVjdGVkOiB0aGlzLmlzRGVmYXVsdFZhbHVlKHBhaXIudmFsdWUpIH0pO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgocmVhc29uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCJURU1QIGVycm9yIGhhbmRsaW5nOiBcIiArIEpTT04uc3RyaW5naWZ5KHJlYXNvbikpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5yZWZyZXNoKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ09NTU9OIERST1BET1dOIERBVEEgU09VUkNFU1xyXG4gICAgLy9cclxuICAgIC8vIElmIHRoZSBkYXRhIHNvdXJjZSBpcyB1c2VkIGluIG1vcmUgdGhhbiBvbmUgcGFnZSwgaXRzIHByb2JhYmx5IGJlc3QgdG8gcHV0IGl0IGhlcmUuXHJcblxyXG4gICAgcHJpdmF0ZSBmcm9tTmFtZUlkR3JhcGhRTChlbnRpdHlOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLmZyb21HcmFwaFFMKHtcclxuICAgICAgICAgICAgcXVlcnk6IGBxdWVyeSBHZXRPd25lcnMge1xyXG4gICAgICAgICAgICAgICAgJHtlbnRpdHlOYW1lfSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWRcclxuICAgICAgICAgICAgICAgICAgICBuYW1lXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1gLFxyXG5cclxuICAgICAgICAgICAgZGF0YUdldHRlcjogKGpzb246IGFueSkgPT4ganNvbltlbnRpdHlOYW1lXS5tYXAoZnVuY3Rpb24gKHY6IHsgbmFtZTogc3RyaW5nLCBpZDogc3RyaW5nIH0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IHYubmFtZSwgdmFsdWU6IFN0cmluZyh2LmlkKSB9O1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmcm9tQ29udGFjdEdyYXBoUUwoKSB7XHJcbiAgICAgICAgdGhpcy5mcm9tTmFtZUlkR3JhcGhRTChcImNvbnRhY3RzXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmcm9tU3BlY2llc0dyYXBoUUwoKSB7XHJcbiAgICAgICAgdGhpcy5mcm9tTmFtZUlkR3JhcGhRTChcInNwZWNpZXNcIik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZyb21Ib2xkaW5nR3JhcGhRTCgpIHtcclxuICAgICAgICB0aGlzLmZyb21OYW1lSWRHcmFwaFFMKFwiaG9sZGluZ3NcIik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZyb21BbmltYWxHcm91cEdyYXBoUUwoKSB7XHJcbiAgICAgICAgdGhpcy5mcm9tTmFtZUlkR3JhcGhRTChcImFuaW1hbEdyb3Vwc1wiKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZnJvbUJyZWVkR3JhcGhRTCgpIHtcclxuICAgICAgICB0aGlzLmZyb21OYW1lSWRHcmFwaFFMKFwiYnJlZWRzXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmcm9tTGlmZUV2ZW50R3JhcGhRTCgpIHtcclxuICAgICAgICB0aGlzLmZyb21OYW1lSWRHcmFwaFFMKFwibGlmZUV2ZW50c1wiKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgRHJvcGRvd247Il19