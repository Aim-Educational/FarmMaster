import { FarmAjax, FarmAjaxMessageType } from "./farm_ajax.js";
export class ComponentSelectOption {
    constructor() {
        this.value = "";
        this.description = "";
        // Not returned by server, but other helper functions:
        this.dataset = {};
    }
}
export class ComponentSelect {
    static populateFromAjaxWithMessageResponse(inputSelect, boxError, ajaxUrl, data) {
        if ((inputSelect instanceof HTMLInputElement && inputSelect.type == "hidden")
            || (inputSelect instanceof HTMLSelectElement && inputSelect.parentElement.classList.contains("dropdown")))
            inputSelect = inputSelect.parentElement;
        if (!inputSelect.classList.contains("ui") && !inputSelect.classList.contains("dropdown"))
            throw "When using Fomantic UI style dropdowns, the 'ui dropdown' classes must be used.";
        inputSelect.classList.add("loading");
        FarmAjax.postWithMessageAndValueResponse(ajaxUrl, data, (response) => {
            inputSelect.classList.remove("loading");
            if (response.messageType == FarmAjaxMessageType.Error) {
                response.populateMessageBox(boxError);
                return;
            }
            if (inputSelect instanceof HTMLSelectElement) {
                while (inputSelect.item.length > 0)
                    inputSelect.remove(0);
                for (let value of response.value) {
                    let option = document.createElement("option");
                    option.value = value.value;
                    option.innerText = value.description;
                    inputSelect.add(option);
                }
            }
            else if (inputSelect instanceof HTMLDivElement) {
                let menu = inputSelect.querySelector("div.menu");
                menu.querySelectorAll("div.item").forEach(e => menu.removeChild(e));
                // Add all the items.
                for (let value of response.value) {
                    let div = document.createElement("div");
                    div.classList.add("item");
                    div.dataset.value = value.value;
                    div.innerText = value.description;
                    menu.appendChild(div);
                }
                // If there's a default value, set all the appropriate things, otherwise just clear the value.
                let input = inputSelect.querySelector("input");
                input.value = (input.dataset.defaultValue) ? input.dataset.defaultValue : "";
                let text = inputSelect.querySelector("div.text");
                text.innerHTML = "";
                menu.querySelectorAll("div.item").forEach((item_) => {
                    let item = item_;
                    if (item.dataset.value == input.value)
                        text.innerHTML = item.innerHTML;
                });
            }
            else
                throw typeof inputSelect;
        });
    }
    static asContentSelector(inputSelect) {
        inputSelect.addEventListener("change", function () {
            let idContent = "";
            if (inputSelect instanceof HTMLSelectElement) {
                let item = inputSelect.selectedOptions.item(0);
                idContent = (item.dataset.contentId) ? item.dataset.contentId : item.value;
            }
            else {
                let options = ComponentSelect.getOptions(inputSelect);
                let item = options.filter(opt => opt.value == inputSelect.value)[0];
                idContent = (item.dataset.contentId) ? item.dataset.contentId : item.value;
            }
            // Hide all other options.
            let options = ComponentSelect.getOptions(inputSelect);
            for (let option of options) {
                document.getElementById((option.dataset.contentId) ? option.dataset.contentId : option.value)
                    .classList.add("transition", "hidden");
            }
            // Show the one we want.
            document.getElementById(idContent).classList.remove("transition", "hidden");
        });
    }
    // A universal way to get the options of either a normal <select>, or a Fomantic UI style select.
    static getOptions(inputSelect) {
        if ((inputSelect instanceof HTMLSelectElement || inputSelect instanceof HTMLInputElement)
            && inputSelect.parentElement.classList.contains("dropdown")) {
            inputSelect = inputSelect.parentElement;
        }
        if (inputSelect instanceof HTMLSelectElement) {
            let list = [];
            for (let i = 0; i < inputSelect.item.length; i++) {
                let item = inputSelect.options.item(i);
                list.push({ value: item.value.toLowerCase(), description: item.innerText, dataset: item.dataset });
            }
            return list;
        }
        if (inputSelect instanceof HTMLDivElement) {
            let list = [];
            inputSelect.querySelectorAll(".menu .item")
                .forEach(function (item_) {
                let item = item_;
                let value = (item.dataset.value) ? item.dataset.value : item.innerText;
                list.push({ value: value.toLowerCase(), description: item.innerText, dataset: item.dataset });
            });
            return list;
        }
        throw "Unsupported type: " + inputSelect;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50X3NlbGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL1NjcmlwdHMvY29tcG9uZW50X3NlbGVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFL0QsTUFBTSxPQUFPLHFCQUFxQjtJQUFsQztRQUNXLFVBQUssR0FBVyxFQUFFLENBQUM7UUFDbkIsZ0JBQVcsR0FBVyxFQUFFLENBQUM7UUFFaEMsc0RBQXNEO1FBQy9DLFlBQU8sR0FBaUIsRUFBRSxDQUFDO0lBQ3RDLENBQUM7Q0FBQTtBQUVELE1BQU0sT0FBTyxlQUFlO0lBQ2pCLE1BQU0sQ0FBQyxtQ0FBbUMsQ0FDN0MsV0FBa0UsRUFDbEUsUUFBa0MsRUFDbEMsT0FBbUIsRUFDbkIsSUFBZ0I7UUFFaEIsSUFBSSxDQUFDLFdBQVcsWUFBWSxnQkFBZ0IsSUFBSSxXQUFXLENBQUMsSUFBSSxJQUFJLFFBQVEsQ0FBQztlQUN0RSxDQUFDLFdBQVcsWUFBWSxpQkFBaUIsSUFBSSxXQUFXLENBQUMsYUFBYyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDMUcsV0FBVyxHQUFtQixXQUFXLENBQUMsYUFBYSxDQUFDO1FBRTVELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztZQUNwRixNQUFNLGlGQUFpRixDQUFDO1FBRTVGLFdBQVcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3JDLFFBQVEsQ0FBQywrQkFBK0IsQ0FBMEIsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBRTFGLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxD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QyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUNsRyxDQUFDLENBQUMsQ0FBQztZQUVQLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFFRCxNQUFNLG9CQUFvQixHQUFHLFdBQVcsQ0FBQztJQUM3QyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGYXJtQWpheCwgRmFybUFqYXhNZXNzYWdlVHlwZSB9IGZyb20gXCIuL2Zhcm1fYWpheC5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIENvbXBvbmVudFNlbGVjdE9wdGlvbiB7XHJcbiAgICBwdWJsaWMgdmFsdWU6IHN0cmluZyA9IFwiXCI7XHJcbiAgICBwdWJsaWMgZGVzY3JpcHRpb246IHN0cmluZyA9IFwiXCI7XHJcblxyXG4gICAgLy8gTm90IHJldHVybmVkIGJ5IHNlcnZlciwgYnV0IG90aGVyIGhlbHBlciBmdW5jdGlvbnM6XHJcbiAgICBwdWJsaWMgZGF0YXNldDogRE9NU3RyaW5nTWFwID0ge307XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDb21wb25lbnRTZWxlY3Qge1xyXG4gICAgcHVibGljIHN0YXRpYyBwb3B1bGF0ZUZyb21BamF4V2l0aE1lc3NhZ2VSZXNwb25zZShcclxuICAgICAgICBpbnB1dFNlbGVjdDogSFRNTFNlbGVjdEVsZW1lbnQgfCBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTERpdkVsZW1lbnQsXHJcbiAgICAgICAgYm94RXJyb3I6ICAgIEhUTUxEaXZFbGVtZW50IHwgbnVsbCxcclxuICAgICAgICBhamF4VXJsOiAgICAgc3RyaW5nLFxyXG4gICAgICAgIGRhdGE6ICAgICAgICBhbnlcclxuICAgICk6IHZvaWQge1xyXG4gICAgICAgIGlmICgoaW5wdXRTZWxlY3QgaW5zdGFuY2VvZiBIVE1MSW5wdXRFbGVtZW50ICYmIGlucHV0U2VsZWN0LnR5cGUgPT0gXCJoaWRkZW5cIilcclxuICAgICAgICAgICAgfHwgKGlucHV0U2VsZWN0IGluc3RhbmNlb2YgSFRNTFNlbGVjdEVsZW1lbnQgJiYgaW5wdXRTZWxlY3QucGFyZW50RWxlbWVudCEuY2xhc3NMaXN0LmNvbnRhaW5zKFwiZHJvcGRvd25cIikpKVxyXG4gICAgICAgICAgICBpbnB1dFNlbGVjdCA9IDxIVE1MRGl2RWxlbWVudD5pbnB1dFNlbGVjdC5wYXJlbnRFbGVtZW50O1xyXG5cclxuICAgICAgICBpZiAoIWlucHV0U2VsZWN0LmNsYXNzTGlzdC5jb250YWlucyhcInVpXCIpICYmICFpbnB1dFNlbGVjdC5jbGFzc0xpc3QuY29udGFpbnMoXCJkcm9wZG93blwiKSlcclxuICAgICAgICAgICAgdGhyb3cgXCJXaGVuIHVzaW5nIEZvbWFudGljIFVJIHN0eWxlIGRyb3Bkb3ducywgdGhlICd1aSBkcm9wZG93bicgY2xhc3NlcyBtdXN0IGJlIHVzZWQuXCI7XHJcblxyXG4gICAgICAgIGlucHV0U2VsZWN0LmNsYXNzTGlzdC5hZGQoXCJsb2FkaW5nXCIpO1xyXG4gICAgICAgIEZhcm1BamF4LnBvc3RXaXRoTWVzc2FnZUFuZFZhbHVlUmVzcG9uc2U8Q29tcG9uZW50U2VsZWN0T3B0aW9uW10+KGFqYXhVcmwsIGRhdGEsIChyZXNwb25zZSkgPT5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGlucHV0U2VsZWN0LmNsYXNzTGlzdC5yZW1vdmUoXCJsb2FkaW5nXCIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLm1lc3NhZ2VUeXBlID09IEZhcm1BamF4TWVzc2FnZVR5cGUuRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLnBvcHVsYXRlTWVzc2FnZUJveCg8SFRNTEVsZW1lbnQ+Ym94RXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaW5wdXRTZWxlY3QgaW5zdGFuY2VvZiBIVE1MU2VsZWN0RWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKGlucHV0U2VsZWN0Lml0ZW0ubGVuZ3RoID4gMClcclxuICAgICAgICAgICAgICAgICAgICBpbnB1dFNlbGVjdC5yZW1vdmUoMCk7XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgdmFsdWUgb2YgcmVzcG9uc2UudmFsdWUhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJvcHRpb25cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uLnZhbHVlID0gdmFsdWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uLmlubmVyVGV4dCA9IHZhbHVlLmRlc2NyaXB0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0U2VsZWN0LmFkZChvcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGlucHV0U2VsZWN0IGluc3RhbmNlb2YgSFRNTERpdkVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIGxldCBtZW51ID0gaW5wdXRTZWxlY3QucXVlcnlTZWxlY3RvcihcImRpdi5tZW51XCIpITtcclxuICAgICAgICAgICAgICAgIG1lbnUucXVlcnlTZWxlY3RvckFsbChcImRpdi5pdGVtXCIpIS5mb3JFYWNoKGUgPT4gbWVudS5yZW1vdmVDaGlsZChlKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQWRkIGFsbCB0aGUgaXRlbXMuXHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCB2YWx1ZSBvZiByZXNwb25zZS52YWx1ZSEpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICAgICAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZChcIml0ZW1cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgZGl2LmRhdGFzZXQudmFsdWUgPSB2YWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBkaXYuaW5uZXJUZXh0ID0gdmFsdWUuZGVzY3JpcHRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgbWVudS5hcHBlbmRDaGlsZChkaXYpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBkZWZhdWx0IHZhbHVlLCBzZXQgYWxsIHRoZSBhcHByb3ByaWF0ZSB0aGluZ3MsIG90aGVyd2lzZSBqdXN0IGNsZWFyIHRoZSB2YWx1ZS5cclxuICAgICAgICAgICAgICAgIGxldCBpbnB1dCA9IGlucHV0U2VsZWN0LnF1ZXJ5U2VsZWN0b3IoXCJpbnB1dFwiKSE7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IChpbnB1dC5kYXRhc2V0LmRlZmF1bHRWYWx1ZSkgPyBpbnB1dC5kYXRhc2V0LmRlZmF1bHRWYWx1ZSA6IFwiXCI7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGxldCB0ZXh0ID0gaW5wdXRTZWxlY3QucXVlcnlTZWxlY3RvcihcImRpdi50ZXh0XCIpITtcclxuICAgICAgICAgICAgICAgIHRleHQuaW5uZXJIVE1MID0gXCJcIjtcclxuXHJcbiAgICAgICAgICAgICAgICBtZW51LnF1ZXJ5U2VsZWN0b3JBbGwoXCJkaXYuaXRlbVwiKS5mb3JFYWNoKChpdGVtXzogSFRNTERpdkVsZW1lbnQgfCBFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGl0ZW0gPSBpdGVtXyBhcyBIVE1MRGl2RWxlbWVudDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5kYXRhc2V0LnZhbHVlID09IGlucHV0LnZhbHVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LmlubmVySFRNTCA9IGl0ZW0uaW5uZXJIVE1MO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgdGhyb3cgdHlwZW9mIGlucHV0U2VsZWN0O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgYXNDb250ZW50U2VsZWN0b3IoaW5wdXRTZWxlY3Q6IEhUTUxTZWxlY3RFbGVtZW50IHwgSFRNTElucHV0RWxlbWVudCkge1xyXG4gICAgICAgIGlucHV0U2VsZWN0LmFkZEV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgZnVuY3Rpb24gKClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGxldCBpZENvbnRlbnQ6IHN0cmluZyA9IFwiXCI7XHJcblxyXG4gICAgICAgICAgICBpZiAoaW5wdXRTZWxlY3QgaW5zdGFuY2VvZiBIVE1MU2VsZWN0RWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW0gPSBpbnB1dFNlbGVjdC5zZWxlY3RlZE9wdGlvbnMuaXRlbSgwKSE7XHJcbiAgICAgICAgICAgICAgICBpZENvbnRlbnQgPSAoaXRlbS5kYXRhc2V0LmNvbnRlbnRJZCkgPyBpdGVtLmRhdGFzZXQuY29udGVudElkIDogaXRlbS52YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxldCBvcHRpb25zID0gQ29tcG9uZW50U2VsZWN0LmdldE9wdGlvbnMoaW5wdXRTZWxlY3QpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW0gPSBvcHRpb25zLmZpbHRlcihvcHQgPT4gb3B0LnZhbHVlID09IGlucHV0U2VsZWN0LnZhbHVlKVswXTtcclxuICAgICAgICAgICAgICAgIGlkQ29udGVudCA9IChpdGVtLmRhdGFzZXQuY29udGVudElkKSA/IGl0ZW0uZGF0YXNldC5jb250ZW50SWQgOiBpdGVtLnZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBIaWRlIGFsbCBvdGhlciBvcHRpb25zLlxyXG4gICAgICAgICAgICBsZXQgb3B0aW9ucyA9IENvbXBvbmVudFNlbGVjdC5nZXRPcHRpb25zKGlucHV0U2VsZWN0KTtcclxuICAgICAgICAgICAgZm9yIChsZXQgb3B0aW9uIG9mIG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKChvcHRpb24uZGF0YXNldC5jb250ZW50SWQpID8gb3B0aW9uLmRhdGFzZXQuY29udGVudElkIDogb3B0aW9uLnZhbHVlKSFcclxuICAgICAgICAgICAgICAgICAgICAuY2xhc3NMaXN0LmFkZChcInRyYW5zaXRpb25cIiwgXCJoaWRkZW5cIik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIFNob3cgdGhlIG9uZSB3ZSB3YW50LlxyXG4gICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZENvbnRlbnQpIS5jbGFzc0xpc3QucmVtb3ZlKFwidHJhbnNpdGlvblwiLCBcImhpZGRlblwiKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBIHVuaXZlcnNhbCB3YXkgdG8gZ2V0IHRoZSBvcHRpb25zIG9mIGVpdGhlciBhIG5vcm1hbCA8c2VsZWN0Piwgb3IgYSBGb21hbnRpYyBVSSBzdHlsZSBzZWxlY3QuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldE9wdGlvbnMoaW5wdXRTZWxlY3Q6IEhUTUxTZWxlY3RFbGVtZW50IHwgSFRNTElucHV0RWxlbWVudCB8IEhUTUxEaXZFbGVtZW50KTogQ29tcG9uZW50U2VsZWN0T3B0aW9uW10ge1xyXG4gICAgICAgIGlmICgoaW5wdXRTZWxlY3QgaW5zdGFuY2VvZiBIVE1MU2VsZWN0RWxlbWVudCB8fCBpbnB1dFNlbGVjdCBpbnN0YW5jZW9mIEhUTUxJbnB1dEVsZW1lbnQpXHJcbiAgICAgICAgICAgICYmIGlucHV0U2VsZWN0LnBhcmVudEVsZW1lbnQhLmNsYXNzTGlzdC5jb250YWlucyhcImRyb3Bkb3duXCIpKSB7XHJcbiAgICAgICAgICAgIGlucHV0U2VsZWN0ID0gPEhUTUxEaXZFbGVtZW50PmlucHV0U2VsZWN0LnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaW5wdXRTZWxlY3QgaW5zdGFuY2VvZiBIVE1MU2VsZWN0RWxlbWVudCkge1xyXG4gICAgICAgICAgICBsZXQgbGlzdDogQ29tcG9uZW50U2VsZWN0T3B0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dFNlbGVjdC5pdGVtLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IGlucHV0U2VsZWN0Lm9wdGlvbnMuaXRlbShpKSE7XHJcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB2YWx1ZTogaXRlbS52YWx1ZS50b0xvd2VyQ2FzZSgpLCBkZXNjcmlwdGlvbjogaXRlbS5pbm5lclRleHQsIGRhdGFzZXQ6IGl0ZW0uZGF0YXNldCB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGxpc3Q7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpbnB1dFNlbGVjdCBpbnN0YW5jZW9mIEhUTUxEaXZFbGVtZW50KSB7XHJcbiAgICAgICAgICAgIGxldCBsaXN0OiBDb21wb25lbnRTZWxlY3RPcHRpb25bXSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgaW5wdXRTZWxlY3QucXVlcnlTZWxlY3RvckFsbChcIi5tZW51IC5pdGVtXCIpIVxyXG4gICAgICAgICAgICAgICAgLmZvckVhY2goZnVuY3Rpb24gKGl0ZW1fOiBIVE1MRGl2RWxlbWVudCB8IEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IGl0ZW1fIGFzIEhUTUxEaXZFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IChpdGVtLmRhdGFzZXQudmFsdWUpID8gaXRlbS5kYXRhc2V0LnZhbHVlIDogaXRlbS5pbm5lclRleHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdmFsdWU6IHZhbHVlLnRvTG93ZXJDYXNlKCksIGRlc2NyaXB0aW9uOiBpdGVtLmlubmVyVGV4dCwgZGF0YXNldDogaXRlbS5kYXRhc2V0IH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbGlzdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRocm93IFwiVW5zdXBwb3J0ZWQgdHlwZTogXCIgKyBpbnB1dFNlbGVjdDtcclxuICAgIH1cclxufSJdfQ==